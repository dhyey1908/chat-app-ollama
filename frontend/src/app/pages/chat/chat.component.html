<!-- Sidebar -->
<div class="chat-sidebar" [class.open]="sidebarOpen">
  <h3>Select Model</h3>
  <mat-form-field appearance="outline" class="model-select">
    <mat-label>Model</mat-label>
    <mat-select [(value)]="selectedModel">
      <mat-option value="gemma3:270m">gemma3:270m</mat-option>
      <mat-option value="gemma:2b">gemma:2b</mat-option>
      <mat-option value="llama3.2:latest">llama3.2:latest</mat-option>
    </mat-select>
  </mat-form-field>

  <button mat-button color="primary" (click)="startNewChat()">+ New Chat</button>
  <button mat-button color="warn" (click)="clearAllChats()">ðŸ—‘ Clear All</button>
  <br><br>
  <h3>Chat History</h3>
  <div class="chat-list">
    <div class="chat-item" *ngFor="let chat of chats" [class.active]="chat.id === activeChat.id">
      <span class="chat-title" (click)="selectChat(chat)">{{ chat.title }}</span>
      <mat-icon color="warn" (click)="removeChat(chat, $event)">delete</mat-icon>
    </div>
  </div>
</div>

<!-- Wrapper to move chat container when sidebar opens -->
<div class="chat-wrapper" [class.shift]="sidebarOpen">
  <div class="chat-container">
    <app-navbar [showSidebarToggle]="true" [sidebarOpen]="sidebarOpen" (sidebarToggle)="toggleSidebar()">
    </app-navbar>

    <div class="chat-messages" #scrollMe>
      <div *ngIf="historyCleared" class="cleared-animation">
        <div class="robot-container">
          <div class="robot-glow"></div>
          <mat-icon class="robot-icon">smart_toy</mat-icon>
        </div>
        <h2>{{ currentMessage }}</h2>
        <p class="subtitle">{{ currentSubtitle }}</p>

        <div class="suggestions">
          <div class="suggestion-chip" (click)="runPrompt('Write a creative poem about coding')">
            <mat-icon>edit</mat-icon> Write a poem
          </div>
          <div class="suggestion-chip" (click)="runPrompt('Explain quantum computing in simple terms')">
            <mat-icon>lightbulb</mat-icon> Explain concepts
          </div>
        </div>
      </div>

      <div *ngFor="let msg of activeChat?.messages; let i = index" class="message-wrapper">
        <div class="message" [ngClass]="msg.from">
          <div class="message-content">
            <ng-container *ngIf="msg.from === 'user'">
              <p>{{ msg.text }}</p>
            </ng-container>
            <ng-container *ngIf="msg.from === 'bot'">
              <div class="bot-avatar-container">
                <div class="bot-avatar">
                  <mat-icon>smart_toy</mat-icon>
                </div>
              </div>
              <div class="bot-text-container">
                <markdown [data]="msg.text"></markdown>
                <div *ngIf="!msg.text && isLoading" class="typing-indicator">
                  <span class="typing-dot"></span>
                  <span class="typing-dot"></span>
                  <span class="typing-dot"></span>
                </div>

                <!-- Action Buttons - Always visible after bot message -->
                <div class="bot-message-actions" *ngIf="msg.text && !isLoading">
                  <button mat-icon-button class="action-btn" (click)="copyMessage(msg.text)" matTooltip="Copy">
                    <mat-icon>content_copy</mat-icon>
                  </button>
                  <button mat-icon-button class="action-btn"
                    *ngIf="activeChat?.messages && i === (activeChat?.messages?.length ?? 0) - 1"
                    (click)="regenerateResponse(i)" matTooltip="Regenerate">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>

    <div class="chat-input">
      <mat-form-field class="input-field" appearance="outline">
        <textarea matInput [(ngModel)]="userInput" placeholder="Type a message..." cdkTextareaAutosize
          cdkAutosizeMinRows="1" cdkAutosizeMaxRows="5" (keyup.enter)="sendMessage()" [disabled]="isLoading">
        </textarea>
      </mat-form-field>
      <button mat-icon-button color="primary" (click)="isLoading ? stopResponse() : sendMessage()">
        <mat-icon>{{ isLoading ? 'stop' : 'send' }}</mat-icon>
      </button>
    </div>
  </div>
</div>