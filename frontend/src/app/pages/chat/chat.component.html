<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" (click)="toggleSidebar()">
  <mat-icon>{{ sidebarOpen ? 'close' : 'menu' }}</mat-icon>
</button>

<!-- Sidebar -->
<div class="chat-sidebar" [class.open]="sidebarOpen">
  <h3>Select Model</h3>
  <mat-form-field appearance="outline" class="model-select">
    <mat-label>Model</mat-label>
    <mat-select [(value)]="selectedModel">
      <mat-option value="gemma:2b">gemma:2b</mat-option>
      <mat-option value="gemma3:270m">gemma3:270m</mat-option>
    </mat-select>
  </mat-form-field>

  <h3>Chats History</h3>
  <button mat-button color="primary" (click)="startNewChat()">+ New Chat</button>
  <button mat-button color="warn" (click)="clearAllChats()">ðŸ—‘ Clear All</button>

  <div class="chat-list">
    <div class="chat-item" *ngFor="let chat of chats" [class.active]="chat.id === activeChat.id">
      <span class="chat-title" (click)="selectChat(chat)">{{ chat.title }}</span>

      <mat-icon color="warn" (click)="removeChat(chat, $event)">delete</mat-icon>
    </div>
  </div>
</div>

<!-- Wrapper to move chat container when sidebar opens -->
<div class="chat-wrapper" [class.shift]="sidebarOpen">
  <div class="chat-container">
    <div class="chat-header">
      <span class="logo" routerLink="/">ðŸ¤– Chatbot UI</span>
    </div>

    <div class="chat-messages" #scrollMe>
      <div *ngIf="historyCleared" class="cleared-animation">
        <div class="robot">ðŸ¤–</div>
        <p>{{ currentMessage }}</p>
      </div>

      <div *ngFor="let msg of activeChat.messages; let i = index">
        <div class="message" [ngClass]="msg.from">
          <mat-card>
            <p *ngIf="msg.from === 'user'">{{ msg.text }}</p>
            <markdown *ngIf="msg.from === 'bot'" [data]="msg.text"></markdown>
            <div *ngIf="msg.from === 'bot' && !msg.text && isLoading" class="dot-loader"></div>
          </mat-card>
        </div>
        <div *ngIf="msg.from === 'bot' && i === activeChat.messages.length - 1 && !isLoading && lastUserMessage"
          class="try-again">
          <span color="primary" (click)="tryAgain()">
            <mat-icon>loop</mat-icon>
          </span>
        </div>
      </div>
    </div>

    <div class="chat-input">
      <mat-form-field class="input-field" appearance="outline">
        <textarea matInput [(ngModel)]="userInput" placeholder="Type a message..." cdkTextareaAutosize
          cdkAutosizeMinRows="1" cdkAutosizeMaxRows="5" (keyup.enter)="sendMessage()" [disabled]="isLoading">
        </textarea>
      </mat-form-field>
      <button mat-icon-button color="primary" (click)="isLoading ? stopResponse() : sendMessage()">
        <mat-icon>{{ isLoading ? 'stop' : 'send' }}</mat-icon>
      </button>
    </div>
  </div>
</div>